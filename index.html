<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOLACHA MAKER V44 - FULL</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --cyan: #00f2ff; --purple: #bc13fe; --yellow: #ffcc00; --red: #ff4444; --bg: #050510; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: #fff; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        #header { background: #0a0a20; height: 50px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--cyan); z-index: 1000; position: relative; }
        #main-content { height: calc(100vh - 50px); display: flex; align-items: center; justify-content: center; width: 100%; overflow-y: auto; }
        .menu-card { background: rgba(10, 10, 35, 0.98); padding: 20px; border-radius: 20px; border: 2px solid var(--purple); width: 90%; max-width: 450px; text-align: center; }
        .btn { width: 100%; padding: 12px; margin: 6px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        
        /* EDITOR */
        #editor-grid { display: grid; grid-template-columns: repeat(60, 40px); grid-template-rows: repeat(20, 40px); background: #111; border: 1px solid #333; cursor: crosshair; }
        .cell { width: 40px; height: 40px; border: 0.1px solid rgba(255,255,255,0.05); box-sizing: border-box; }
        #palette { position: fixed; right: 20px; top: 70px; display: flex; flex-direction: column; gap: 5px; background: #000; padding: 10px; border-radius: 10px; border: 1px solid var(--cyan); }
        .p-item { width: 40px; height: 40px; border: 2px solid transparent; cursor: pointer; }
        .p-item.active { border-color: #fff; }

        /* JOGO */
        #game-view { width: 100vw; height: calc(100vh - 50px); position: relative; overflow: hidden; background: #000; }
        #world { position: absolute; transform-origin: 0 0; }
        #player { position: absolute; width: 30px; height: 30px; background: var(--cyan); border: 2px solid #fff; border-radius: 5px; z-index: 100; }
        .obj { position: absolute; width: 40px; height: 40px; }
        .block { background: #555; } .lava { background: var(--red); box-shadow: 0 0 10px var(--red); } .ice { background: #a0e9ff; } .spring { background: #50ff50; } .flag { background: var(--yellow); clip-path: polygon(0 0, 100% 50%, 0 100%); }
        .spawn { border: 2px dashed var(--cyan); }

        /* RANKING */
        #rank-box { background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; margin-bottom: 15px; text-align: left; }
        .rank-line { display: flex; justify-content: space-between; font-size: 13px; padding: 4px 0; border-bottom: 1px solid #222; }

        /* CHAT */
        #chat-area { position: fixed; bottom: 20px; left: 10px; width: 220px; height: 150px; background: rgba(0,0,0,0.8); border: 1px solid var(--purple); border-radius: 10px; display: flex; flex-direction: column; z-index: 9000; }
        #chat-msgs { flex-grow: 1; overflow-y: auto; padding: 5px; font-size: 11px; }
        #chat-in { background: #000; border: none; color: #fff; padding: 8px; border-top: 1px solid var(--purple); outline: none; }
    </style>
</head>
<body>
    <div id="header" class="hidden">
        <div id="d-nick">...</div>
        <div style="color:var(--yellow)">üí∞ <span id="coins">0</span></div>
        <button id="adm-btn" class="hidden" onclick="abrirAdm()" style="background:var(--red); color:#fff; border:none; padding:5px 10px; border-radius:4px;">ADM</button>
    </div>

    <div id="main-content"></div>

    <div id="chat-area" class="hidden">
        <div id="chat-msgs"></div>
        <input type="text" id="chat-in" placeholder="Diga algo...">
    </div>

    <script>
        const cfg = { apiKey: "AIzaSyCBSYgExCqXc8dmkB2yyBuznofShzE-h7o", authDomain: "bolachamakergame.firebaseapp.com", databaseURL: "https://bolachamakergame-default-rtdb.firebaseio.com", projectId: "bolachamakergame", appId: "1:207720367456:web:1a58957162be2b080f4a05" };
        firebase.initializeApp(cfg);
        const db = firebase.database();
        
        let nick = localStorage.getItem('maker_nick'), moedas = 0, inv = {};
        let game = false, loopId = null, curMap = [], pX=0, pY=0, vX=0, vY=0, keys = {};
        let brush = 'block';

        function init() {
            if(!nick) return login();
            document.getElementById('header').classList.remove('hidden');
            db.ref('ranking/'+nick).on('value', s => {
                const d = s.val() || {moedas:500};
                moedas = d.moedas; inv = d.inv || {};
                document.getElementById('coins').innerText = Math.floor(moedas);
                document.getElementById('d-nick').innerText = nick;
                if(nick.toLowerCase()==='bolacha') document.getElementById('adm-btn').classList.remove('hidden');
                if(!game) menu();
            });
            window.onkeydown = e => keys[e.code] = true;
            window.onkeyup = e => keys[e.code] = false;
        }

        function menu() {
            cancelAnimationFrame(loopId);
            game = false; document.getElementById('chat-area').classList.add('hidden');
            document.getElementById('main-content').innerHTML = `
                <div class="menu-card">
                    <h1 style="color:var(--cyan)">BOLACHA MAKER</h1>
                    <div id="rank-box">Carregando TOP 5...</div>
                    <button class="btn" style="background:var(--cyan)" onclick="galeria()">JOGAR</button>
                    <button class="btn" style="background:var(--purple); color:#fff" onclick="editor()">CRIAR FASE</button>
                    <button class="btn" style="background:var(--yellow); color:#000" onclick="loja()">LOJA</button>
                </div>`;
            db.ref('ranking').orderByChild('moedas').limitToLast(5).once('value', s => {
                let h = "<b>üèÜ RANKING MOEDAS</b><br>";
                let p = []; s.forEach(u => p.push({n:u.key, m:u.val().moedas}));
                p.reverse().forEach((u,i) => h += `<div class="rank-line"><span>${i+1}.${u.n}</span><span>$${Math.floor(u.m)}</span></div>`);
                document.getElementById('rank-box').innerHTML = h;
            });
        }

        function editor() {
            let h = `<div style="overflow:auto; width:100%; height:100%; background:#050510;">
                <div id="palette">
                    <div class="p-item block active" onclick="setB('block',this)"></div>
                    <div class="p-item lava" onclick="setB('lava',this)"></div>
                    <div class="p-item ice" onclick="setB('ice',this)"></div>
                    <div class="p-item spring" onclick="setB('spring',this)"></div>
                    <div class="p-item spawn" onclick="setB('spawn',this)"></div>
                    <div class="p-item flag" onclick="setB('flag',this)"></div>
                    <button onclick="salvarMapa()" style="margin-top:10px;">SALVAR</button>
                    <button onclick="menu()">SAIR</button>
                </div>
                <div id="editor-grid"></div>
            </div>`;
            document.getElementById('main-content').innerHTML = h;
            const grid = document.getElementById('editor-grid');
            for(let i=0; i<1200; i++) {
                const c = document.createElement('div');
                c.className = 'cell';
                c.onclick = () => { c.className = 'cell '+brush; c.dataset.type = brush; };
                grid.appendChild(c);
            }
        }

        function setB(t, el) { brush=t; document.querySelectorAll('.p-item').forEach(i=>i.classList.remove('active')); el.classList.add('active'); }

        function salvarMapa() {
            const dados = [];
            document.querySelectorAll('.cell').forEach((c, i) => {
                if(c.dataset.type) dados.push({id: i, cl: c.dataset.type});
            });
            if(dados.length > 0) {
                db.ref('mapas').push({autor: nick, dados: dados});
                alert("Mapa Enviado!");
                menu();
            }
        }

        function galeria() {
            document.getElementById('main-content').innerHTML = `<div class="menu-card" style="max-width:500px"><h2>GALERIA</h2><div id="m-grid" class="map-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div><button class="btn" onclick="menu()">VOLTAR</button></div>`;
            db.ref('mapas').limitToLast(10).once('value', s => {
                s.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'btn'; div.style.background = '#222';
                    div.innerHTML = m.val().autor;
                    div.onclick = () => play(m.val().dados);
                    document.getElementById('m-grid').appendChild(div);
                });
            });
        }

        function play(d) {
            cancelAnimationFrame(loopId);
            game = true; curMap = d; vX=0; vY=0;
            document.getElementById('chat-area').classList.remove('hidden');
            document.getElementById('main-content').innerHTML = `<div id="game-view"><div id="world"><div id="player"></div><div id="objs"></div></div></div>`;
            d.forEach(b => {
                const o = document.createElement('div');
                const x = (b.id % 60) * 40, y = Math.floor(b.id / 60) * 40;
                o.className = 'obj ' + b.cl;
                o.style.left = x + 'px'; o.style.top = y + 'px';
                document.getElementById('objs').appendChild(o);
                if(b.cl === 'spawn') { pX = x; pY = y; }
            });
            loop();
        }

        function loop() {
            if(!game) return;
            vY += 0.8;
            if(keys['KeyA'] || keys['ArrowLeft']) vX = -6;
            else if(keys['KeyD'] || keys['ArrowRight']) vX = 6;
            else vX *= 0.8;
            
            pX += vX; col(true);
            pY += vY; col(false);

            if((keys['Space'] || keys['ArrowUp']) && vY === 0) vY = -14;

            const w = document.getElementById('world');
            w.style.transform = `translate(${window.innerWidth/2 - pX}px, ${window.innerHeight/2 - pY}px)`;
            const p = document.getElementById('player');
            p.style.left = pX + 'px'; p.style.top = pY + 'px';
            
            loopId = requestAnimationFrame(loop);
        }

        function col(isX) {
            curMap.forEach(b => {
                const bx = (b.id % 60) * 40, by = Math.floor(b.id / 60) * 40;
                if(pX < bx + 40 && pX + 30 > bx && pY < by + 40 && pY + 30 > by) {
                    if(b.cl === 'block' || b.cl === 'ice' || b.cl === 'spring') {
                        if(isX) { pX -= vX; vX = 0; }
                        else { 
                            if(vY > 0) { pY = by - 30; vY = b.cl === 'spring' ? -20 : 0; }
                            else { pY = by + 40; vY = 0; }
                        }
                    }
                    if(b.cl === 'lava') play(curMap);
                    if(b.cl === 'flag') { game = false; db.ref('ranking/'+nick+'/moedas').transaction(c => (c||0)+100); menu(); }
                }
            });
        }

        function login() {
            document.getElementById('main-content').innerHTML = `<div class="menu-card"><h2>ENTRAR</h2><input type="text" id="n-in" placeholder="Nick" style="padding:10px;width:80%"><button class="btn" onclick="let v=document.getElementById('n-in').value; if(v){nick=v;localStorage.setItem('maker_nick',v);init();}">LOGAR</button></div>`;
        }

        init();
    </script>
</body>
</html>
