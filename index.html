<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOLACHA MAKER V55 - SISTEMA ANTIGO</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --cyan: #00f2ff; --purple: #bc13fe; --yellow: #ffcc00; --red: #ff4444; --bg: #050510; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: #fff; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        #header { background: #0a0a20; height: 50px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--cyan); z-index: 1000; position: relative; }
        #main-content { height: calc(100vh - 50px); display: flex; align-items: center; justify-content: center; width: 100%; overflow: hidden; }
        .menu-card { background: rgba(10, 10, 35, 0.98); padding: 20px; border-radius: 20px; border: 2px solid var(--purple); width: 90%; max-width: 480px; text-align: center; }
        .btn { width: 100%; padding: 12px; margin: 6px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; background: #eee; color: #000; }
        
        /* EDITOR & GRID */
        #editor-container { width: 100vw; height: calc(100vh - 50px); overflow: auto; background: #000; }
        #editor-grid { display: grid; grid-template-columns: repeat(60, 40px); grid-template-rows: repeat(20, 40px); width: 2400px; height: 800px; background-image: linear-gradient(to right, #111 1px, transparent 1px), linear-gradient(to bottom, #111 1px, transparent 1px); background-size: 40px 40px; }
        .cell { width: 40px; height: 40px; }
        
        /* BLOCOS */
        .obj { width: 40px; height: 40px; position: absolute; }
        .block { background: #555; border: 2px solid #333; }
        .lava { background: var(--red); box-shadow: inset 0 0 10px #000; }
        .ice { background: #a0e9ff; border: 1px solid #fff; }
        .spring { background: #50ff50; border-top: 6px solid #fff; }
        .flag { background: var(--yellow); clip-path: polygon(0 0, 100% 50%, 0 100%); }
        .spawn { border: 2px dashed var(--cyan); opacity: 0.5; }

        /* JOGO */
        #game-view { width: 100vw; height: calc(100vh - 50px); position: relative; overflow: hidden; }
        #world { position: absolute; width: 2400px; height: 800px; }
        #player { position: absolute; width: 32px; height: 32px; background: var(--cyan); border: 2px solid #fff; border-radius: 4px; z-index: 100; }
        .ghost { position: absolute; width: 32px; height: 32px; background: rgba(0, 242, 255, 0.3); border: 1px solid #fff; border-radius: 4px; }
        
        #palette { position: fixed; right: 10px; top: 60px; display: flex; flex-direction: column; gap: 5px; background: #000; padding: 10px; border-radius: 10px; border: 1px solid var(--cyan); z-index: 10000; }
        .p-item { width: 35px; height: 35px; border: 2px solid transparent; cursor: pointer; }
        .p-item.active { border-color: #fff; }
    </style>
</head>
<body>
    <div id="header" class="hidden">
        <div id="d-nick"></div>
        <div style="color:var(--yellow)">ðŸ’° <span id="coins">0</span></div>
    </div>
    <div id="main-content"></div>

    <script>
        const cfg = { apiKey: "AIzaSyCBSYgExCqXc8dmkB2yyBuznofShzE-h7o", authDomain: "bolachamakergame.firebaseapp.com", databaseURL: "https://bolachamakergame-default-rtdb.firebaseio.com", projectId: "bolachamakergame", appId: "1:207720367456:web:1a58957162be2b080f4a05" };
        firebase.initializeApp(cfg);
        const db = firebase.database();
        
        let nick = localStorage.getItem('maker_nick'), moedas = 0, inv = {}, game = false, loopId = null;
        let pX=0, pY=0, vX=0, vY=0, keys = {}, curMapData = [], currentMapId = "", brush = 'block';

        function init() {
            if(!nick) return login();
            document.getElementById('header').classList.remove('hidden');
            db.ref('ranking/'+nick).on('value', s => {
                const d = s.val() || {moedas:500, inv:{}};
                moedas = d.moedas; inv = d.inv || {};
                document.getElementById('coins').innerText = Math.floor(moedas);
                document.getElementById('d-nick').innerText = nick;
                if(!game) menu();
            });
            window.onkeydown = e => keys[e.code] = true;
            window.onkeyup = e => keys[e.code] = false;
        }

        function menu() {
            cancelAnimationFrame(loopId); game = false;
            document.getElementById('main-content').innerHTML = `
                <div class="menu-card">
                    <h1 style="color:var(--cyan)">BOLACHA MAKER</h1>
                    <button class="btn" style="background:var(--cyan)" onclick="galeria()">JOGAR</button>
                    <button class="btn" style="background:var(--purple); color:#fff" onclick="editor()">CRIAR</button>
                    <button class="btn" style="background:var(--yellow)" onclick="loja()">LOJA</button>
                </div>`;
        }

        function play(dados, id) {
            cancelAnimationFrame(loopId); game = true; curMapData = dados; currentMapId = id; vX=0; vY=0;
            document.getElementById('main-content').innerHTML = `<div id="game-view"><div id="world"><div id="player"></div><div id="objs"></div></div></div>`;
            dados.forEach(b => {
                const o = document.createElement('div'); const x=(b.id%60)*40, y=Math.floor(b.id/60)*40;
                o.className = 'obj ' + b.cl; o.style.left = x+'px'; o.style.top = y+'px';
                document.getElementById('objs').appendChild(o);
                if(b.cl==='spawn') { pX=x; pY=y; }
            });
            loop();
        }

        function loop() {
            if(!game) return;
            vY += 0.8;
            
            // FÃ­sica de Atrito (Gelo)
            let friction = 0.8;
            let onIce = false;
            curMapData.forEach(b => {
                const bx=(b.id%60)*40, by=Math.floor(b.id/60)*40;
                if(pX < bx + 40 && pX + 32 > bx && pY + 33 >= by && pY + 30 <= by && b.cl === 'ice') onIce = true;
            });
            if(onIce) friction = 0.98;

            if(keys['KeyA'] || keys['ArrowLeft']) vX = onIce ? vX - 0.2 : -6; 
            else if(keys['KeyD'] || keys['ArrowRight']) vX = onIce ? vX + 0.2 : 6; 
            else vX *= friction;

            // Sistema Antigo de ColisÃ£o (X e Y separados)
            pX += vX; col(true);
            pY += vY; col(false);

            if((keys['Space'] || keys['ArrowUp'] || keys['KeyW']) && vY === 0) vY = -15;
            if(pY > 1200) play(curMapData, currentMapId);

            document.getElementById('world').style.transform = `translate(${window.innerWidth/2-pX}px, ${window.innerHeight/2-pY}px)`;
            document.getElementById('player').style.left = pX+'px'; document.getElementById('player').style.top = pY+'px';
            loopId = requestAnimationFrame(loop);
        }

        function col(isX) {
            curMapData.forEach(b => {
                const bx=(b.id%60)*40, by=Math.floor(b.id/60)*40;
                // DistÃ¢ncia simples para otimizar
                if(pX < bx + 40 && pX + 32 > bx && pY < by + 40 && pY + 32 > by) {
                    if(['block', 'ice', 'spring'].includes(b.cl)) {
                        if(isX) {
                            if(vX > 0) pX = bx - 32; else if(vX < 0) pX = bx + 40;
                            vX = 0;
                        } else {
                            if(vY > 0) { 
                                pY = by - 32; 
                                vY = b.cl === 'spring' ? -25 : 0; 
                            } else if(vY < 0) { 
                                pY = by + 40; vY = 0; 
                            }
                        }
                    }
                    if(b.cl==='lava') play(curMapData, currentMapId);
                    if(b.cl==='flag') { game=false; db.ref('ranking/'+nick+'/moedas').transaction(c=>(c||0)+150); menu(); }
                }
            });
        }

        // --- EDITOR, LOJA E GALERIA (Mantidos como solicitado) ---
        function editor() {
            let h = `<div id="editor-container"><div id="palette">
                <div class="p-item block active" onclick="selB('block',this)" style="background:#555"></div>
                <div class="p-item spawn" onclick="selB('spawn',this)" style="border:1px dashed #fff"></div>
                <div class="p-item flag" onclick="selB('flag',this)" style="background:var(--yellow)"></div>
                ${inv.lava ? '<div class="p-item lava" onclick="selB(\'lava\',this)" style="background:var(--red)"></div>' : ''}
                ${inv.ice ? '<div class="p-item ice" onclick="selB(\'ice\',this)" style="background:#a0e9ff"></div>' : ''}
                ${inv.spring ? '<div class="p-item spring" onclick="selB(\'spring\',this)" style="background:#50ff50"></div>' : ''}
                <button onclick="salvar()">SALVAR</button><button onclick="menu()">SAIR</button>
            </div><div id="editor-grid"></div></div>`;
            document.getElementById('main-content').innerHTML = h;
            const g = document.getElementById('editor-grid');
            window.selB = (b, el) => { brush=b; document.querySelectorAll('.p-item').forEach(i=>i.classList.remove('active')); el.classList.add('active'); };
            for(let i=0; i<1200; i++){
                const c = document.createElement('div'); c.className='cell';
                c.onclick = () => { c.className='cell '+brush; c.dataset.t=brush; };
                g.appendChild(c);
            }
            window.salvar = () => {
                const d = []; document.querySelectorAll('.cell').forEach((c,i)=>{ if(c.dataset.t) d.push({id:i, cl:c.dataset.t}); });
                if(d.length>0){ db.ref('mapas').push({autor:nick, dados:d}); menu(); }
            };
        }

        function loja() {
            let h = `<h2>LOJA</h2>
                <button class="btn" style="background:var(--red)" onclick="buy('lava',500)">LAVA - $500 ${inv.lava?'âœ”':''}</button>
                <button class="btn" style="background:#a0e9ff;color:#000" onclick="buy('ice',800)">GELO - $800 ${inv.ice?'âœ”':''}</button>
                <button class="btn" style="background:#50ff50;color:#000" onclick="buy('spring',1200)">MOLA - $1200 ${inv.spring?'âœ”':''}</button>
                <button class="btn" onclick="menu()">VOLTAR</button>`;
            document.getElementById('main-content').innerHTML = `<div class="menu-card">${h}</div>`;
            window.buy = (id, p) => { 
                if(inv[id]) return;
                if(moedas>=p) db.ref('ranking/'+nick).update({moedas:moedas-p, [`inv/${id}`]:true}).then(()=>loja()); 
            };
        }

        function galeria() {
            document.getElementById('main-content').innerHTML = `<div class="menu-card"><h2>MAPAS</h2><div id="m-g" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div><button class="btn" onclick="menu()">VOLTAR</button></div>`;
            db.ref('mapas').once('value', s => {
                s.forEach(m => {
                    const b = document.createElement('button'); b.className='btn'; b.style.background='#222'; b.style.color='#fff';
                    b.innerText = m.val().autor; b.onclick=()=>play(m.val().dados, m.key);
                    document.getElementById('m-g').appendChild(b);
                });
            });
        }

        function login() {
            document.getElementById('main-content').innerHTML = `<div class="menu-card"><h2>NICK</h2><input id="ni" style="padding:10px;width:80%"><button class="btn" onclick="nick=document.getElementById('ni').value;localStorage.setItem('maker_nick',nick);init()">ENTRAR</button></div>`;
        }

        init();
    </script>
</body>
</html>
