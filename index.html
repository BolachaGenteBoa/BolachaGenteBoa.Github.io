<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOLACHA MAKER V57 - COLIS√ÉO REAL</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --cyan: #00f2ff; --purple: #bc13fe; --yellow: #ffcc00; --red: #ff4444; --bg: #050510; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: #fff; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        #header { background: #0a0a20; height: 50px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--cyan); z-index: 1000; position: relative; }
        #main-content { height: calc(100vh - 50px); display: flex; align-items: center; justify-content: center; width: 100%; }
        
        .menu-card { background: rgba(10, 10, 35, 0.98); padding: 20px; border-radius: 20px; border: 2px solid var(--purple); width: 90%; max-width: 480px; text-align: center; }
        .btn { width: 100%; padding: 12px; margin: 6px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; background: #eee; color: #000; }

        #game-view { width: 100vw; height: calc(100vh - 50px); position: relative; overflow: hidden; background: #000; }
        #world { position: absolute; width: 2400px; height: 800px; }
        
        /* O Player deve estar sempre vis√≠vel mas respeitar a colis√£o */
        #player { position: absolute; width: 30px; height: 30px; background: var(--cyan); border: 2px solid #fff; border-radius: 4px; z-index: 100; box-shadow: 0 0 10px var(--cyan); }
        
        .obj { width: 40px; height: 40px; position: absolute; box-sizing: border-box; z-index: 10; }
        .block { background: #444; border: 2px solid #666; } /* Bloco s√≥lido */
        .lava { background: var(--red); box-shadow: inset 0 0 10px #000; }
        .ice { background: #a0e9ff; border: 1px solid #fff; }
        .spring { background: #50ff50; border-top: 6px solid #fff; }
        .flag { background: var(--yellow); clip-path: polygon(0 0, 100% 50%, 0 100%); }
        .spawn { border: 2px dashed var(--cyan); opacity: 0.3; }

        #editor-grid { display: grid; grid-template-columns: repeat(60, 40px); width: 2400px; height: 800px; background: #111; }
        .cell { width: 40px; height: 40px; border: 0.1px solid #222; }
    </style>
</head>
<body>
    <div id="header" class="hidden"><div id="d-nick"></div><div style="color:var(--yellow)">üí∞ <span id="coins">0</span></div></div>
    <div id="main-content"></div>

    <script>
        const cfg = { apiKey: "AIzaSyCBSYgExCqXc8dmkB2yyBuznofShzE-h7o", authDomain: "bolachamakergame.firebaseapp.com", databaseURL: "https://bolachamakergame-default-rtdb.firebaseio.com", projectId: "bolachamakergame", appId: "1:207720367456:web:1a58957162be2b080f4a05" };
        firebase.initializeApp(cfg);
        const db = firebase.database();

        let nick = localStorage.getItem('maker_nick'), moedas = 0, inv = {}, game = false;
        let pX=0, pY=0, vX=0, vY=0, keys = {}, grid = {}, brush = 'block';

        function init() {
            if(!nick) return login();
            document.getElementById('header').classList.remove('hidden');
            db.ref('ranking/'+nick).on('value', s => {
                const d = s.val() || {moedas:500};
                moedas = d.moedas; document.getElementById('coins').innerText = Math.floor(moedas);
                document.getElementById('d-nick').innerText = nick;
                if(!game) menu();
            });
            window.onkeydown = e => keys[e.code] = true;
            window.onkeyup = e => keys[e.code] = false;
        }

        function menu() {
            game = false;
            document.getElementById('main-content').innerHTML = `
                <div class="menu-card">
                    <h1 style="color:var(--cyan)">BOLACHA MAKER</h1>
                    <button class="btn" onclick="galeria()">JOGAR</button>
                    <button class="btn" onclick="editor()">CRIAR</button>
                </div>`;
        }

        // Fun√ß√£o crucial: Checa se o ponto (x,y) √© um bloco s√≥lido
        function isSolid(x, y) {
            const tx = Math.floor(x / 40);
            const ty = Math.floor(y / 40);
            const type = grid[`${tx},${ty}`];
            // APENAS estes tipos impedem o movimento
            return (type === 'block' || type === 'ice' || type === 'spring');
        }

        function getTileType(x, y) {
            return grid[`${Math.floor(x/40)},${Math.floor(y/40)}`];
        }

        function play(dados) {
            game = true; grid = {}; vX=vY=0;
            document.getElementById('main-content').innerHTML = `<div id="game-view"><div id="world"><div id="player"></div><div id="objs"></div></div></div>`;
            
            dados.forEach(b => {
                const tx = b.id % 60, ty = Math.floor(b.id / 60);
                grid[`${tx},${ty}`] = b.cl; // Salva no mapa de colis√£o
                const o = document.createElement('div');
                o.className = 'obj ' + b.cl;
                o.style.left = (tx*40)+'px'; o.style.top = (ty*40)+'px';
                document.getElementById('objs').appendChild(o);
                if(b.cl==='spawn') { pX = tx*40; pY = ty*40; }
            });
            requestAnimationFrame(loop);
        }

        function loop() {
            if(!game) return;

            vY += 0.8; // Gravidade
            if(vY > 16) vY = 16;

            // Movimento X
            let speed = 6;
            if(isSolid(pX+15, pY+32) && getTileType(pX+15, pY+32) === 'ice') speed = 8; // Gelo corre mais

            if(keys['ArrowLeft'] || keys['KeyA']) vX = -speed;
            else if(keys['ArrowRight'] || keys['KeyD']) vX = speed;
            else vX *= 0.8;

            // --- F√çSICA EIXO X ---
            pX += vX;
            if(isSolid(pX, pY+5) || isSolid(pX+30, pY+5) || isSolid(pX, pY+25) || isSolid(pX+30, pY+25)) {
                if(vX > 0) pX = Math.floor((pX+30)/40)*40 - 30.1;
                else if(vX < 0) pX = Math.floor(pX/40)*40 + 40.1;
                vX = 0;
            }

            // --- F√çSICA EIXO Y ---
            pY += vY;
            if(isSolid(pX+2, pY) || isSolid(pX+28, pY) || isSolid(pX+2, pY+30) || isSolid(pX+28, pY+30)) {
                if(vY > 0) { // Ch√£o
                    const tileAbaixo = getTileType(pX+15, pY+30);
                    pY = Math.floor((pY+30)/40)*40 - 30.1;
                    vY = (tileAbaixo === 'spring') ? -24 : 0;
                } else if(vY < 0) { // Teto
                    pY = Math.floor(pY/40)*40 + 40.1;
                    vY = 0;
                }
            }

            // --- SENSORES DE MORTE/VIT√ìRIA ---
            const currentTile = getTileType(pX+15, pY+15);
            if(currentTile === 'lava' || pY > 900) { play(Object.entries(grid).map(([k,v])=>({id:parseInt(k.split(',')[1])*60+parseInt(k.split(',')[0]),cl:v}))); return; }
            if(currentTile === 'flag') { game=false; db.ref('ranking/'+nick+'/moedas').transaction(c=>c+100); menu(); return; }

            // Pulo
            if((keys['ArrowUp'] || keys['Space'] || keys['KeyW']) && isSolid(pX+15, pY+32)) vY = -15;

            // C√¢mera e Desenho
            document.getElementById('player').style.left = pX+'px';
            document.getElementById('player').style.top = pY+'px';
            document.getElementById('world').style.transform = `translate(${window.innerWidth/2 - pX}px, ${window.innerHeight/2 - pY}px)`;
            
            requestAnimationFrame(loop);
        }

        function editor() {
            let h = `<div id="palette" style="position:fixed;top:60px;right:10px;z-index:100;background:#000;padding:10px;border:1px solid var(--cyan)">
                <div class="p-item block" style="width:30px;height:30px;background:#444;margin-bottom:5px;cursor:pointer" onclick="brush='block'"></div>
                <div class="p-item lava" style="width:30px;height:30px;background:var(--red);margin-bottom:5px;cursor:pointer" onclick="brush='lava'"></div>
                <div class="p-item spawn" style="width:30px;height:30px;border:1px dashed #fff;margin-bottom:5px;cursor:pointer" onclick="brush='spawn'"></div>
                <div class="p-item flag" style="width:30px;height:30px;background:var(--yellow);margin-bottom:5px;cursor:pointer" onclick="brush='flag'"></div>
                <button onclick="salvar()">SALVAR</button><button onclick="menu()">SAIR</button>
            </div><div id="editor-grid" style="overflow:auto;height:calc(100vh - 50px)">`;
            for(let i=0; i<1200; i++) h += `<div class="cell" onclick="this.className='cell '+brush; this.dataset.t=brush"></div>`;
            document.getElementById('main-content').innerHTML = h + `</div>`;
            window.salvar = () => {
                const d = []; document.querySelectorAll('.cell').forEach((c,i)=>{ if(c.dataset.t) d.push({id:i, cl:c.dataset.t}); });
                db.ref('mapas').push({autor:nick, dados:d}); menu();
            };
        }

        function galeria() {
            document.getElementById('main-content').innerHTML = `<div class="menu-card"><h2>GALERIA</h2><div id="m-g"></div><button class="btn" onclick="menu()">VOLTAR</button></div>`;
            db.ref('mapas').limitToLast(10).once('value', s => {
                s.forEach(m => {
                    const b = document.createElement('button'); b.className='btn';
                    b.innerText = "MAPA DE: " + m.val().autor.toUpperCase(); 
                    b.onclick=()=>play(m.val().dados);
                    document.getElementById('m-g').appendChild(b);
                });
            });
        }

        function login() {
            document.getElementById('main-content').innerHTML = `<div class="menu-card"><h2>NICKNAME</h2><input id="ni" style="padding:10px;width:80%"><br><br><button class="btn" onclick="nick=document.getElementById('ni').value;localStorage.setItem('maker_nick',nick);init()">ENTRAR</button></div>`;
        }

        init();
    </script>
</body>
</html>
